<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Time Splitter</title>

<link rel="manifest" href="data:application/manifest+json,{ 
  &quot;name&quot;: &quot;Time Splitter&quot;, 
  &quot;short_name&quot;: &quot;Splitter&quot;, 
  &quot;start_url&quot;: &quot;.&quot;, 
  &quot;display&quot;: &quot;standalone&quot;, 
  &quot;background_color&quot;: &quot;#f2f2f2&quot;, 
  &quot;theme_color&quot;: &quot;#2563eb&quot;, 
  &quot;icons&quot;: [{ &quot;src&quot;: &quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%232563eb'/><rect x='20' y='45' width='60' height='10' fill='white'/></svg>&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/svg+xml&quot; }] 
}" />
<meta name="theme-color" content="#2563eb" />

<style>
  :root {
    --bg: #f8f9fa;
    --text: #222;
    --card-bg: #fff;
    --border: #ddd;
    --accent: #2563eb;
    --input-bg: #fff;
  }

  body.dark {
    --bg: #121212;
    --text: #eee;
    --card-bg: #1e1e1e;
    --border: #333;
    --input-bg: #1b1b1b;
  }

  body {
    font-family: system-ui, Roboto, Arial, sans-serif;
    margin: 0;
    padding: 10px;
    background: var(--bg);
    color: var(--text);
    transition: background 0.3s, color 0.3s;
  }

  #controls {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  button {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 0.9rem;
    cursor: pointer;
  }

  button.small {
    padding: 3px 6px;
    font-size: 0.8rem;
  }

  input {
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px;
    font-size: 0.85rem;
    width: 100%;
    background: var(--input-bg);
    color: var(--text);
  }

  .player-row {
    display: grid;
    grid-template-columns: 1.3fr 0.9fr 0.9fr 0.6fr 0.8fr auto;
    align-items: center;
    gap: 4px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px 6px;
    margin-bottom: 6px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  #summary {
    margin-top: 10px;
    background: var(--card-bg);
    border-radius: 8px;
    padding: 8px;
    border: 1px solid var(--border);
  }

  #summary p {
    margin: 2px 0;
    font-size: 0.85rem;
  }

  @media (max-width: 600px) {
    .player-row {
      grid-template-columns: 1fr 0.8fr 0.8fr 0.6fr 0.8fr auto;
      font-size: 0.8rem;
    }
  }
</style>
</head>

<body>
  <div id="controls">
    <button id="addPlayer">+ Player</button>
    <button id="exportCSV">Export CSV</button>
    <input type="number" id="totalCost" placeholder="Total Cost" style="flex:1; min-width:100px;">
    <button id="toggleTheme" style="background:#444;">ðŸŒ—</button>
  </div>

  <div id="players"></div>

  <div id="summary">
    <p><strong>Session Start:</strong> <span id="sessionStart">â€“</span></p>
    <p><strong>Session End:</strong> <span id="sessionEnd">â€“</span></p>
    <p><strong>Total Minutes:</strong> <span id="totalMinutes">0</span></p>
  </div>

<script>
const playersDiv = document.getElementById('players');
const totalCostInput = document.getElementById('totalCost');
const sessionStartEl = document.getElementById('sessionStart');
const sessionEndEl = document.getElementById('sessionEnd');
const totalMinutesEl = document.getElementById('totalMinutes');
let players = JSON.parse(localStorage.getItem('timeSplitterPlayers') || '[]');
let darkMode = localStorage.getItem('timeSplitterDark') === 'true';

if (darkMode) document.body.classList.add('dark');

document.getElementById('toggleTheme').onclick = () => {
  document.body.classList.toggle('dark');
  darkMode = document.body.classList.contains('dark');
  localStorage.setItem('timeSplitterDark', darkMode);
};

function renderPlayers() {
  playersDiv.innerHTML = '';
  const totalMins = calcTotalMinutes();
  const totalCost = parseFloat(totalCostInput.value) || 0;

  players.forEach((p, i) => {
    const mins = (p.start && p.end) ? calcMinutes(p.start, p.end) : 0;
    const cost = totalMins > 0 ? (totalCost * mins / totalMins).toFixed(2) : '';

    const row = document.createElement('div');
    row.className = 'player-row';
    row.innerHTML = `
      <input type="text" value="${p.name||''}" placeholder="Name" onchange="updatePlayer(${i}, 'name', this.value)">
      <input type="time" value="${p.start||''}" onchange="updatePlayer(${i}, 'start', this.value)">
      <input type="time" value="${p.end||''}" onchange="updatePlayer(${i}, 'end', this.value)">
      <input type="number" value="${mins||''}" readonly placeholder="Min">
      <input type="number" value="${cost}" readonly placeholder="Cost">
      <button class="small" onclick="removePlayer(${i})">âœ–</button>
    `;
    playersDiv.appendChild(row);
  });

  calc();
}

function updatePlayer(i, key, value) {
  players[i][key] = value;
  save();
  renderPlayers();
}

function addPlayer() {
  players.push({name:'', start:'', end:''});
  save();
  renderPlayers();
}

function removePlayer(i) {
  players.splice(i, 1);
  save();
  renderPlayers();
}

function save() {
  localStorage.setItem('timeSplitterPlayers', JSON.stringify(players));
}

function calcMinutes(start, end) {
  const s = new Date('1970-01-01T' + start + ':00');
  const e = new Date('1970-01-01T' + end + ':00');
  let diff = (e - s) / 60000;
  if (diff < 0) diff += 1440;
  return diff;
}

function calcTotalMinutes() {
  return players.reduce((sum, p) => {
    if (p.start && p.end) sum += calcMinutes(p.start, p.end);
    return sum;
  }, 0);
}

function calc() {
  let totalMins = 0;
  let minTime = null;
  let maxTime = null;
  players.forEach(p => {
    if(p.start && p.end) {
      const start = new Date('1970-01-01T' + p.start + ':00');
      const end = new Date('1970-01-01T' + p.end + ':00');
      let diff = (end - start) / 60000;
      if (diff < 0) diff += 1440;
      totalMins += diff;
      if(!minTime || start < minTime) minTime = start;
      if(!maxTime || end > maxTime) maxTime = end;
    }
  });
  totalMinutesEl.textContent = totalMins;
  sessionStartEl.textContent = minTime ? minTime.toTimeString().substring(0,5) : 'â€“';
  sessionEndEl.textContent = maxTime ? maxTime.toTimeString().substring(0,5) : 'â€“';
}

document.getElementById('addPlayer').onclick = addPlayer;
totalCostInput.oninput = renderPlayers;
document.getElementById('exportCSV').onclick = () => {
  const rows = [['Player','Start','End','Minutes','Cost']];
  const totalMins = calcTotalMinutes();
  const totalCost = parseFloat(totalCostInput.value) || 0;
  players.forEach(p => {
    const mins = (p.start && p.end) ? calcMinutes(p.start, p.end) : '';
    const cost = totalMins > 0 ? (totalCost * mins / totalMins).toFixed(2) : '';
    rows.push([p.name, p.start, p.end, mins, cost]);
  });
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'time-splitter.csv'; a.click();
  URL.revokeObjectURL(url);
};

if ('serviceWorker' in navigator) {
  const sw = `
  self.addEventListener('install', e => e.waitUntil(caches.open('ts-cache').then(c => c.addAll(['./']))));
  self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
  `;
  const blob = new Blob([sw], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl);
}

renderPlayers();
</script>
</body>
</html>
