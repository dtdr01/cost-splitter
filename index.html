<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cost Splitter</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 10px;
    color: #222;
    transition: background 0.3s, color 0.3s;
  }
  body.dark {
    background: #1a1a1a;
    color: #e0e0e0;
  }
  h2 {
    text-align: center;
    color: #0055cc;
    margin-bottom: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    font-size: 14px;
    transition: background 0.3s;
  }
  body.dark table {
    background: #2a2a2a;
  }
  th, td {
    padding: 4px 6px;
    text-align: center;
    border-bottom: 1px solid #ddd;
    transition: border-color 0.3s;
  }
  body.dark th, body.dark td {
    border-bottom: 1px solid #444;
  }
  th {
    background: #e9f0ff;
    color: #0044aa;
    font-weight: bold;
    transition: background 0.3s, color 0.3s;
  }
  body.dark th {
    background: #333;
    color: #66aaff;
  }
  tr:last-child td {
    border-bottom: none;
  }
  input[type="text"], input[type="time"], input[type="number"] {
    width: 90%;
    padding: 2px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    background: #fff;
    color: #222;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
  }
  body.dark input[type="text"], 
  body.dark input[type="time"], 
  body.dark input[type="number"] {
    background: #3a3a3a;
    color: #e0e0e0;
    border-color: #555;
  }
  input[type="time"] {
    text-align: center;
    font-variant-numeric: tabular-nums;
  }
  input[type="time"]::-webkit-datetime-edit-ampm-field {
    display: none;
  }
  input[type="time"]::-webkit-clear-button,
  input[type="time"]::-webkit-inner-spin-button {
    display: none;
  }
  button {
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    margin: 5px 2px;
    cursor: pointer;
  }
  .add-btn {
    background: #007bff;
    color: white;
  }
  .remove-btn {
    background: #ff6666;
    color: white;
    padding: 2px 6px;
  }
  .new-session {
    background: #999;
    color: white;
    float: right;
  }
  .summary {
    margin-top: 10px;
    background: #fff;
    padding: 8px;
    border-radius: 8px;
    font-size: 14px;
    transition: background 0.3s;
  }
  body.dark .summary {
    background: #2a2a2a;
  }
  .theme-toggle {
    background: #555;
    color: white;
    margin-top: 10px;
    width: 100%;
  }
  body.dark .theme-toggle {
    background: #777;
  }
  @media (max-width: 600px) {
    th, td { font-size: 12px; padding: 3px; }
    input { font-size: 12px; }
    button { font-size: 12px; }
  }
</style>
</head>
<body>

<h2>Cost Splitter</h2>

<div style="margin-bottom:8px;">
  <button class="add-btn" onclick="addPlayer()">+ Player</button>
  <button class="new-session" onclick="newSession()">New Session</button>
</div>

<table id="playerTable">
  <thead>
    <tr>
      <th>Player</th>
      <th>Joined</th>
      <th>Left</th>
      <th>Min</th>
      <th>Cost</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="summary">
  <label>Total Cost: <input type="number" id="totalCost" value="" placeholder="Enter cost" min="0" onchange="updateCosts()" style="width:70px;"> RON</label>
  <br>
  <strong>Session:</strong> <span id="sessionTime">–</span>
</div>

<button class="theme-toggle" onclick="toggleTheme()">Toggle Dark/Light Theme</button>

<script>
let players = [];

// Load saved data on startup
window.onload = function() {
  loadData();
  loadTheme();
};

function saveData() {
  const rows = document.querySelectorAll("#playerTable tbody tr");
  const data = [];
  
  rows.forEach(row => {
    const name = row.children[0].querySelector("input").value;
    const joined = row.children[1].querySelector("input").value;
    const left = row.children[2].querySelector("input").value;
    data.push({ name, joined, left });
  });
  
  const totalCost = document.getElementById("totalCost").value;
  const state = { players: data, totalCost };
  localStorage.setItem("costSplitterData", JSON.stringify(state));
}

function loadData() {
  const saved = localStorage.getItem("costSplitterData");
  if (saved) {
    const state = JSON.parse(saved);
    document.getElementById("totalCost").value = state.totalCost || "";
    
    state.players.forEach(player => {
      addPlayerWithData(player.name, player.joined, player.left);
    });
    
    updateCosts();
  }
}

function addPlayer() {
  addPlayerWithData("", "", "");
}

function addPlayerWithData(name, joined, left) {
  const tbody = document.querySelector("#playerTable tbody");
  const row = document.createElement("tr");

  row.innerHTML = `
    <td><input type="text" placeholder="Name" value="${name}" onchange="saveData()"></td>
    <td><input type="time" value="${joined}" onchange="updateCosts(); saveData()"></td>
    <td><input type="time" value="${left}" onchange="updateCosts(); saveData()"></td>
    <td class="minutes">0</td>
    <td class="cost">0</td>
    <td><button class="remove-btn" onclick="removePlayer(this)">✕</button></td>
  `;

  tbody.appendChild(row);
  updateCosts();
  saveData();
}

function removePlayer(btn) {
  btn.closest("tr").remove();
  updateCosts();
  saveData();
}

function newSession() {
  if (!confirm("Start a new session? All current data will be cleared.")) return;
  document.querySelector("#playerTable tbody").innerHTML = "";
  document.getElementById("totalCost").value = "";
  document.getElementById("sessionTime").textContent = "–";
  players = [];
  localStorage.removeItem("costSplitterData");
}

function updateCosts() {
  const rows = document.querySelectorAll("#playerTable tbody tr");
  let totalMinutes = 0;
  let minStart = null, maxEnd = null;

  rows.forEach(row => {
    const start = row.children[1].querySelector("input").value;
    const end = row.children[2].querySelector("input").value;
    const minCell = row.querySelector(".minutes");
    const costCell = row.querySelector(".cost");

    if (start && end) {
      const diff = timeDiffMinutes(start, end);
      minCell.textContent = diff;
      totalMinutes += diff;
      if (!minStart || start < minStart) minStart = start;
      if (!maxEnd || end > maxEnd) maxEnd = end;
    } else {
      minCell.textContent = "0";
      costCell.textContent = "0";
    }
  });

  const totalCost = parseFloat(document.getElementById("totalCost").value) || 0;
  const costPerMinute = totalMinutes > 0 ? totalCost / totalMinutes : 0;

  rows.forEach(row => {
    const mins = parseFloat(row.querySelector(".minutes").textContent) || 0;
    const playerCost = (mins * costPerMinute).toFixed(2);
    row.querySelector(".cost").textContent = playerCost;
  });

  document.getElementById("sessionTime").textContent = minStart && maxEnd ? `${minStart} → ${maxEnd}` : "–";
  saveData();
}

function timeDiffMinutes(start, end) {
  const [sh, sm] = start.split(":").map(Number);
  const [eh, em] = end.split(":").map(Number);
  return (eh * 60 + em) - (sh * 60 + sm);
}

function toggleTheme() {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  localStorage.setItem("costSplitterTheme", isDark ? "dark" : "light");
}

function loadTheme() {
  const theme = localStorage.getItem("costSplitterTheme");
  if (theme === "dark") {
    document.body.classList.add("dark");
  }
}
</script>
</body>
</html>
