<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cost Splitter</title>
  <meta name="theme-color" content="#ffffff"/>

  <style>
    :root{
      --bg: #f8fafc;
      --text: #0f172a;
      --muted: #6b7280;
      --card: #ffffff;
      --accent: #1f6feb; /* blue accent */
      --border: #e6eefc;
      --radius: 10px;
    }
    body.dark{
      --bg: #0b1220;
      --text: #e6eef8;
      --muted: #93a3bd;
      --card: #0f1724;
      --border: #16202b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Roboto,Arial}
    .app{max-width:980px;margin:0 auto;padding:12px;padding-bottom:88px}

    /* Top bar */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(180deg,#e8f4ff,#d6eaff);display:flex;align-items:center;justify-content:center}
    .apptitle{font-weight:700;font-size:1rem}
    .controls{display:flex;gap:8px;align-items:center}

    /* compact controls */
    .input-cost{min-width:120px;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--card);font-size:0.95rem}
    .btn{background:var(--accent);color:white;border:0;padding:8px 10px;border-radius:10px;font-weight:600}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(31,111,235,0.12)}
    .btn.ghost{background:transparent;border:0;color:var(--muted)}

    /* header row */
    #header-row{display:grid;grid-template-columns:1.3fr 0.65fr 0.65fr 0.5fr 0.7fr 40px;gap:8px;padding:8px 6px;margin-bottom:6px;font-weight:700;color:var(--muted);font-size:13px}
    .grid-row{display:grid;grid-template-columns:1.3fr 0.65fr 0.65fr 0.5fr 0.7fr 40px;gap:8px;align-items:center;margin-bottom:6px}

    .card-cell{background:var(--card);border:1px solid var(--border);padding:6px;border-radius:8px}

    input[type="text"], input[type="number"], input[type="time"]{
      width:100%;padding:6px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;
    }

    /* Force 24h display by hiding AM/PM for WebKit browsers */
    input[type="time"]{font-variant-numeric:tabular-nums;text-align:center}
    input[type="time"]::-webkit-datetime-edit-ampm-field{display:none}
    input[type="time"]::-webkit-clear-button,input[type="time"]::-webkit-inner-spin-button{display:none}

    /* small remove btn */
    .remove{background:#ef4444;color:white;border:0;border-radius:6px;padding:6px 6px;font-weight:700;cursor:pointer}

    /* summary & bottom */
    .summary{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:8px;margin-top:8px;background:var(--card);border-radius:10px;border:1px solid var(--border)}
    .summary .left{font-size:13px;color:var(--muted)}
    .summary .right{font-weight:700;font-size:15px}

    footer.fixed{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),var(--bg));backdrop-filter:blur(6px);border-top:1px solid var(--border);display:flex;justify-content:center;box-shadow:0 -6px 18px rgba(0,0,0,0.04)}

    /* responsive */
    @media(max-width:640px){
      #header-row,.grid-row{grid-template-columns:1fr 0.6fr 0.6fr 0.5fr 0.6fr 36px;font-size:12px}
      .apptitle{font-size:0.95rem}
      .logo{width:36px;height:36px}
      .input-cost{min-width:96px}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- svg paddle icon -->
          <svg width="28" height="28" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="6" y="12" width="36" height="24" rx="6" fill="#1f6feb"/>
            <rect x="28" y="36" width="8" height="16" rx="4" fill="#6b7280"/>
            <circle cx="50" cy="18" r="6" fill="#ffffff" stroke="#cfe1ff" stroke-width="1.5"/>
          </svg>
        </div>
        <div>
          <div class="apptitle">Cost Splitter</div>
        </div>
      </div>

      <div class="controls">
        <input id="totalCost" class="input-cost" type="number" placeholder="" aria-label="Total cost">
        <button id="addPlayer" class="btn">+ Player</button>
        <button id="exportCsv" class="btn secondary">Export CSV</button>
        <!-- theme toggle top-right -->
        <button id="toggleTheme" title="Toggle theme" class="btn ghost" style="margin-left:6px">ðŸŒ—</button>
      </div>
    </div>

    <div id="header-row">
      <div>Player</div><div>Joined</div><div>Left</div><div>Min</div><div>Cost</div><div></div>
    </div>

    <div id="playersList" aria-live="polite"></div>

    <div class="summary" id="summary">
      <div class="left">Session: <span id="sessionTime">â€“</span></div>
      <div class="right">Total minutes: <span id="totalMinutes">0</span></div>
    </div>

  </div>

  <footer class="fixed">
    <div style="width:980px;max-width:96%;display:flex;justify-content:space-between;gap:8px">
      <button id="newSession" class="btn secondary" style="background:#ef4444;color:white;border-radius:10px">New Session</button>
      <div style="flex:1"></div>
      <div style="display:flex;gap:8px">
        <button id="recalc" class="btn">Recalculate</button>
      </div>
    </div>
  </footer>

<script>
const STORAGE_KEY = 'cost-splitter-state-v1';
const THEME_KEY = 'cost-splitter-theme-v1';

let state = { players: [], totalCost: '' };
try { const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = JSON.parse(raw); } catch(e){}

let theme = localStorage.getItem(THEME_KEY) || 'light';
if(theme === 'dark') document.body.classList.add('dark');

const playersList = document.getElementById('playersList');
const totalCostInput = document.getElementById('totalCost');
const sessionTimeEl = document.getElementById('sessionTime');
const totalMinutesEl = document.getElementById('totalMinutes');

totalCostInput.value = state.totalCost || '';

function createRowItem(idx, p){
  const row = document.createElement('div');
  row.className = 'grid-row';
  row.innerHTML = `
    <div class="card-cell"><input type="text" class="pname" value="${escapeHtml(p.name||'')}" placeholder="Name"></div>
    <div class="card-cell"><input type="time" class="pstart" value="${p.start||''}"></div>
    <div class="card-cell"><input type="time" class="pend" value="${p.end||''}"></div>
    <div class="card-cell"><input type="number" class="pmins" value="" readonly></div>
    <div class="card-cell"><input type="number" class="pcost" value="" readonly></div>
    <div class="card-cell" style="display:flex;align-items:center;justify-content:center"><button class="remove" title="Remove">âœ–</button></div>
  `;
  row.querySelector('.pname').addEventListener('input', e=>{ state.players[idx].name = e.target.value; saveState(); render(); });
  row.querySelector('.pstart').addEventListener('input', e=>{ state.players[idx].start = e.target.value; saveState(); render(); });
  row.querySelector('.pend').addEventListener('input', e=>{ state.players[idx].end = e.target.value; saveState(); render(); });
  row.querySelector('.remove').addEventListener('click', ()=>{ state.players.splice(idx,1); saveState(); render(); });
  return row;
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function addPlayer(){
  state.players.push({name:'', start:'', end:''});
  saveState();
  render();
  setTimeout(()=>{ const rows = playersList.querySelectorAll('.grid-row'); if(rows.length) rows[rows.length-1].querySelector('.pname').focus(); },50);
}

function saveState(){ state.totalCost = totalCostInput.value || ''; try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }

function calcMinutes(start, end){
  if(!start || !end) return 0;
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  let mins = (eh*60 + em) - (sh*60 + sm);
  if(mins < 0) mins += 24*60;
  return mins;
}

function calcAll(){
  const players = state.players;
  let totalMins = 0;
  let minStart = null, maxEnd = null;
  players.forEach(p=>{
    const mins = calcMinutes(p.start, p.end);
    totalMins += mins;
    if(p.start){ if(minStart === null || p.start < minStart) minStart = p.start; }
    if(p.end){ if(maxEnd === null || p.end > maxEnd) maxEnd = p.end; }
  });
  const totalCost = parseFloat(state.totalCost) || 0;
  players.forEach(p=>{
    const mins = calcMinutes(p.start, p.end);
    p._mins = mins;
    p._cost = totalMins>0 ? +(totalCost * mins / totalMins).toFixed(2) : '';
  });
  return { totalMins, minStart, maxEnd };
}

function render(){
  playersList.innerHTML = '';
  state.players.forEach((p, i)=>{ playersList.appendChild(createRowItem(i,p)); });
  const { totalMins, minStart, maxEnd } = calcAll();
  const rows = playersList.querySelectorAll('.grid-row');
  rows.forEach((r, idx)=>{ const p = state.players[idx]; r.querySelector('.pmins').value = p._mins || ''; r.querySelector('.pcost').value = (p._cost!==undefined && p._cost!=='') ? p._cost : ''; });
  totalMinutesEl.textContent = totalMins;
  sessionTimeEl.textContent = (minStart && maxEnd) ? `${minStart} â†’ ${maxEnd}` : 'â€“';
  saveState();
}

function exportCsv(){
  const header = ['Player','Joined','Left','Minutes','Cost'];
  const rows = [header];
  const { totalMins } = calcAll();
  const totalCost = parseFloat(state.totalCost) || 0;
  state.players.forEach(p=>{
    const mins = p._mins || 0;
    const cost = p._cost!==undefined && p._cost!=='' ? p._cost : (totalMins>0 ? +(totalCost * mins / totalMins).toFixed(2) : '');
    rows.push([p.name || '', p.start || '', p.end || '', mins, cost]);
  });
  const csv = rows.map(r=>r.map(cell=>typeof cell==='string' && cell.includes(',') ? `"${cell.replace(/"/g,'""')}"` : cell).join(',')).join('\\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'cost-splitter.csv'; a.click(); URL.revokeObjectURL(url);
}

function newSession(){
  if(!confirm('Start a new session in Cost Splitter? This will clear all player data.')) return;
  state.players = []; state.totalCost = ''; totalCostInput.value = ''; saveState(); render();
}

document.getElementById('toggleTheme').addEventListener('click', ()=>{
  theme = (theme==='dark') ? 'light' : 'dark';
  localStorage.setItem(THEME_KEY, theme);
  document.body.classList.toggle('dark', theme==='dark');
});
document.getElementById('addPlayer').addEventListener('click', addPlayer);
document.getElementById('exportCsv').addEventListener('click', exportCsv);
document.getElementById('newSession').addEventListener('click', newSession);
document.getElementById('recalc').addEventListener('click', render);
totalCostInput.addEventListener('input', ()=>{ state.totalCost = totalCostInput.value; saveState(); render(); });

if('serviceWorker' in navigator){
  const sw = `
self.addEventListener('install', e => e.waitUntil(caches.open('cost-splitter-cache-v1').then(c => c.addAll(['./']))));
self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));
`;
  const blob = new Blob([sw], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(()=>{});
}

render();
</script>
</body>
</html>
