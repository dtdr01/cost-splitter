<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cost Splitter</title>
<style>
  :root {
    --bg-color: #f5f5f5;
    --text-color: #222;
    --surface-bg: #fff;
    --border-color: #ddd;
    --header-bg: #e9f0ff;
    --header-color: #0044aa;
    --primary-accent: #007bff;
    --modal-bg: #f0f0f0;
  }
  body.dark {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --surface-bg: #2a2a2a;
    --border-color: #444;
    --header-bg: #333;
    --header-color: #66aaff;
    --primary-accent: #007bff;
    --modal-bg: #383838;
  }
  body {
    font-family: Arial, sans-serif;
    background: var(--bg-color);
    margin: 0;
    padding: 10px;
    color: var(--text-color);
    transition: background 0.3s, color 0.3s;
  }
  h2 {
    text-align: center;
    color: #0055cc;
    margin-bottom: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface-bg);
    border-radius: 10px;
    overflow: hidden;
    font-size: 14px;
    transition: background 0.3s;
    table-layout: fixed;
  }
  th, td {
    padding: 4px 3px;
    text-align: center;
    vertical-align: middle;
    border-bottom: 1px solid var(--border-color);
    transition: border-color 0.3s;
  }
  #playerTable th:nth-child(1) { width: 20%; } /* Player */
  #playerTable th:nth-child(2) { width: 28%; } /* Joined */
  #playerTable th:nth-child(3) { width: 28%; } /* Left */
  #playerTable th:nth-child(4) { width: 8%; }  /* Min */
  #playerTable th:nth-child(5) { width: 10%; } /* Cost */
  #playerTable th:nth-child(6) { width: 6%; }  /* Remove button */
  
  th {
    background: var(--header-bg);
    color: var(--header-color);
    font-weight: bold;
    transition: background 0.3s, color 0.3s;
  }
  tr:last-child td { border-bottom: none; }
  input[type="text"], input[type="number"], input[type="time"] {
    width: 95%;
    box-sizing: border-box;
    padding: 3px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--surface-bg);
    color: var(--text-color);
    transition: background 0.3s, color 0.3s, border-color 0.3s;
  }
  .time-input {
    text-align: left;
    font-variant-numeric: tabular-nums;
  }
  /* --- NEW: Hide the time input's picker arrow to save space --- */
  .time-input::-webkit-calendar-picker-indicator {
    display: none;
  }
  button {
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    margin: 5px 2px;
    cursor: pointer;
  }
  .add-btn { background: var(--primary-accent); color: white; }
  .remove-btn { background: #ff6666; color: white; padding: 2px 6px; }
  .new-session { background: #999; color: white; float: right; }
  .export-btn { background: #28a745; color: white; }
  .summary {
    margin-top: 10px;
    background: var(--surface-bg);
    padding: 8px;
    border-radius: 8px;
    font-size: 14px;
    transition: background 0.3s;
  }
  .theme-toggle {
    background: #555; color: white; margin-top: 10px; width: 100%;
  }
  body.dark .theme-toggle { background: #777; }
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); display: none; align-items: center;
    justify-content: center; z-index: 1000;
  }
  .modal-content {
    background: var(--modal-bg); padding: 20px; border-radius: 8px;
    text-align: center; width: 80%; max-width: 300px; color: var(--text-color);
  }
  .modal-content p { margin-top: 0; margin-bottom: 20px; }
  .modal-buttons button { padding: 10px 20px; margin: 0 5px; border-radius: 5px; font-weight: bold; }
  #confirmOkBtn { background-color: #00b8d4; color: #fff; border: 2px solid #00b8d4; }
  #confirmCancelBtn { background-color: transparent; color: var(--text-color); border: 2px solid #888; }

  @media (max-width: 600px) {
    th, td, input, button { font-size: 12px; }
    th, td { padding: 3px; }
  }
</style>
</head>
<body>

<h2>Cost Splitter</h2>

<div style="margin-bottom:8px;">
  <button class="add-btn" onclick="addPlayer()">+ Player</button>
  <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
  <button class="new-session" onclick="showNewSessionConfirm()">New Session</button>
</div>

<table id="playerTable">
  <thead>
    <tr>
      <th>Player</th>
      <th>Joined</th>
      <th>Left</th>
      <th>Min</th>
      <th>Cost</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="summary">
  <label>Total Cost: <input type="number" id="totalCost" value="" placeholder="Enter cost" min="0" onchange="updateCosts()" style="width:70px;"> RON</label>
  <br>
  <strong>Session:</strong> <span id="sessionTime">–</span>
</div>

<button class="theme-toggle" onclick="toggleTheme()">Toggle Dark/Light Theme</button>

<div id="customConfirmModal" class="modal-overlay">
  <div class="modal-content">
    <p id="confirmMessage"></p>
    <div class="modal-buttons">
      <button id="confirmOkBtn">OK</button>
      <button id="confirmCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
let confirmCallback = null;

window.onload = function() {
  loadData();
  loadTheme();
  
  document.getElementById('confirmOkBtn').addEventListener('click', () => {
    if (confirmCallback) confirmCallback();
    closeConfirmModal();
  });
  
  document.getElementById('confirmCancelBtn').addEventListener('click', closeConfirmModal);
  
  document.getElementById('customConfirmModal').addEventListener('click', (e) => {
    if (e.target.id === 'customConfirmModal') closeConfirmModal();
  });
};

function closeConfirmModal() {
  document.getElementById('customConfirmModal').style.display = 'none';
  confirmCallback = null;
}

function saveData() {
  const rows = document.querySelectorAll("#playerTable tbody tr");
  const data = [];
  rows.forEach(row => {
    data.push({
      name: row.children[0].querySelector("input").value,
      joined: row.children[1].querySelector("input").value,
      left: row.children[2].querySelector("input").value,
    });
  });
  const totalCost = document.getElementById("totalCost").value;
  localStorage.setItem("costSplitterData", JSON.stringify({ players: data, totalCost }));
}

function loadData() {
  const saved = localStorage.getItem("costSplitterData");
  if (saved) {
    const state = JSON.parse(saved);
    document.getElementById("totalCost").value = state.totalCost || "";
    state.players.forEach(p => addPlayerWithData(p.name, p.joined, p.left));
    updateCosts();
  }
}

function addPlayer() {
  addPlayerWithData("", "", "");
}

function addPlayerWithData(name, joined, left) {
  const tbody = document.querySelector("#playerTable tbody");
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input type="text" placeholder="Name" value="${name}" onchange="saveData()"></td>
    <td><input type="time" class="time-input" value="${joined}" onchange="updateCosts(); saveData()"></td>
    <td><input type="time" class="time-input" value="${left}" onchange="updateCosts(); saveData()"></td>
    <td class="minutes">0</td>
    <td class="cost">0</td>
    <td><button class="remove-btn" onclick="removePlayer(this)">✕</button></td>
  `;
  tbody.appendChild(row);
  updateCosts();
  saveData();
}

function removePlayer(btn) {
  btn.closest("tr").remove();
  updateCosts();
  saveData();
}

function showNewSessionConfirm() {
  document.getElementById('confirmMessage').textContent = "Start a new session in Cost Splitter? This will clear all player data.";
  confirmCallback = () => {
    document.querySelector("#playerTable tbody").innerHTML = "";
    document.getElementById("totalCost").value = "";
    document.getElementById("sessionTime").textContent = "–";
    localStorage.removeItem("costSplitterData");
  };
  document.getElementById('customConfirmModal').style.display = 'flex';
}

function updateCosts() {
  const rows = document.querySelectorAll("#playerTable tbody tr");
  let totalMinutes = 0, minStart = null, maxEnd = null;

  rows.forEach(row => {
    const start = row.children[1].querySelector("input").value;
    const end = row.children[2].querySelector("input").value;
    
    if (start && end) {
      const diff = timeDiffMinutes(start, end);
      row.querySelector(".minutes").textContent = diff;
      totalMinutes += diff;
      if (!minStart || start < minStart) minStart = start;
      if (!maxEnd || end > maxEnd) maxEnd = end;
    } else {
      row.querySelector(".minutes").textContent = "0";
      row.querySelector(".cost").textContent = "0";
    }
  });

  const totalCost = parseFloat(document.getElementById("totalCost").value) || 0;
  const costPerMinute = totalMinutes > 0 ? totalCost / totalMinutes : 0;

  rows.forEach(row => {
    const mins = parseFloat(row.querySelector(".minutes").textContent) || 0;
    row.querySelector(".cost").textContent = (mins * costPerMinute).toFixed(2);
  });

  document.getElementById("sessionTime").textContent = minStart && maxEnd ? `${minStart} → ${maxEnd}` : "–";
  saveData();
}

function timeDiffMinutes(start, end) {
  const [sh, sm] = start.split(":").map(Number);
  const [eh, em] = end.split(":").map(Number);
  let diff = (eh * 60 + em) - (sh * 60 + sm);
  return diff < 0 ? diff + 1440 : diff;
}

function exportToCSV() {
    let csvContent = "data:text/csv;charset=utf-8,";
    const headers = ["Player", "Joined", "Left", "Minutes", "Cost"];
    csvContent += headers.join(",") + "\\r\\n";

    const rows = document.querySelectorAll("#playerTable tbody tr");
    rows.forEach(row => {
        const name = `"${row.children[0].querySelector("input").value.replace(/"/g, '""')}"`;
        const joined = row.children[1].querySelector("input").value;
        const left = row.children[2].querySelector("input").value;
        const minutes = row.querySelector(".minutes").textContent;
        const cost = row.querySelector(".cost").textContent;
        
        csvContent += [name, joined, left, minutes, cost].join(",") + "\\r\\n";
    });
    
    const totalCost = document.getElementById('totalCost').value || "0";
    const sessionTime = `"${document.getElementById('sessionTime').textContent}"`;
    csvContent += "\\r\\nTotal Cost," + totalCost + ",Session," + sessionTime + "\\r\\n";

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    const date = new Date().toISOString().slice(0, 10);
    link.setAttribute("download", `cost-splitter-data_${date}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function toggleTheme() {
  document.body.classList.toggle("dark");
  localStorage.setItem("costSplitterTheme", document.body.classList.contains("dark") ? "dark" : "light");
}

function loadTheme() {
  if (localStorage.getItem("costSplitterTheme") === "dark") {
    document.body.classList.add("dark");
  }
}
</script>
</body>
</html>
